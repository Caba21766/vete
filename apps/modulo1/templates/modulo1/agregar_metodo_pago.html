{% extends 'base.html' %}
{% load static %}

{% block contenido %}
<style>
    .form-control-sm {
        font-size: 0.85rem;
        padding: 0.3rem 0.6rem;
    }

    .input-corto {
        width: 230px;
    }

    .tabla-estrecha {
        width: 75%;
        margin: auto;
    }

    .title-section {
        margin-top: 1.5rem;
        margin-bottom: 0.5rem;
    }

    .accordion-button {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }

    .accordion-body {
        padding: 0.6rem;
    }

    .form-group {
        margin-bottom: 0.7rem;
    }

    .alert {
        margin-bottom: 0.5rem;
        padding: 0.4rem;
    }

    h1, h2 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
</style>

<div class="container mt-3">
    <h1 class="text-center title-section">Agregar Método de Pago</h1>

    {% if messages %}
        <div id="mensaje-flash">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} text-center">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="POST" class="mb-3">
        {% csrf_token %}
        <div class="row align-items-center g-2">
            <div class="col-auto">
                <label for="tarjeta_nombre" class="col-form-label">Nombre de la Tarjeta</label>
            </div>
            <div class="col-auto">
                <input type="text" id="tarjeta_nombre" name="tarjeta_nombre"
                    class="form-control form-control-sm"
                    placeholder="Ej: Visa, Mastercard" required>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-primary">Guardar</button>
            </div>
        </div>
    </form>

    <h2 class="text-center title-section">Métodos de Pago Registrados</h2>
    <div class="table-responsive">
        <table class="table table-sm table-striped table-bordered tabla-estrecha text-center">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for metodo in metodos_pago %}
                    <tr>
                        <td>{{ metodo.id }}</td>
                        <td>{{ metodo.tarjeta_nombre }}</td>
                        <td>
                            <a href="{% url 'modulo1:asignar_cuotas' metodo.id %}" class="btn btn-sm btn-secondary">Cuotas</a>
                            <a href="{% url 'modulo1:eliminar_metodo_pago' metodo.id %}" class="btn btn-sm btn-danger">Eliminar</a>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="3">No hay métodos de pago registrados.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h2 class="text-center title-section">Cuotas por Método de Pago</h2>
    <div class="accordion tabla-estrecha" id="accordionCuotas">
        {% for metodo in metodos_pago %}
            <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ metodo.id }}">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ metodo.id }}" aria-expanded="false" aria-controls="collapse{{ metodo.id }}">
                        {{ metodo.tarjeta_nombre }}
                    </button>
                </h2>
                <div id="collapse{{ metodo.id }}" class="accordion-collapse collapse" aria-labelledby="heading{{ metodo.id }}" data-bs-parent="#accordionCuotas">
                    <div class="accordion-body">
                        {% if metodo.cuotas_interes.all %}
                            <table class="table table-sm table-bordered mb-1">
                                <thead>
                                    <tr>
                                        <th>Cuota Nº</th>
                                        <th>Interés (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cuota in metodo.cuotas_interes.all %}
                                        <tr>
                                            <td>{{ cuota.cantidad_cuotas }}</td>
                                            <td>{{ cuota.porcentaje_interes }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <p class="text-muted m-0">No tiene cuotas registradas.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<script>
    setTimeout(function () {
        const flash = document.getElementById('mensaje-flash');
        if (flash) {
            flash.style.transition = "opacity 0.5s ease-out";
            flash.style.opacity = 0;
            setTimeout(() => flash.remove(), 600);
        }
    }, 3000);
</script>
{% endblock %}
