{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block navegacion %}
{% include 'navegacion.html' %}
{% endblock %}

{% block contenido %}
  
    <header>
        <hr>
        <h1>Cuentas Corrientes1</h1>
    </header>
    
    <main>
        {% if user.is_staff %}
        <form method="GET" style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 10px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
  
            <div style="display: flex; flex-direction: column;">
              <label for="dni_cliente" style="font-weight: bold; color: #0b2c4e;">DNI Cliente:</label>
              <input type="text" name="dni_cliente" id="dni_cliente"
                     value="{{ request.GET.dni_cliente|default_if_none:'' }}"
                     style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">
            </div>
          
            <div style="display: flex; flex-direction: column;">
              <label for="fecha" style="font-weight: bold; color: #0b2c4e;">Fecha:</label>
              <input type="date" name="fecha" id="fecha"
                     style="padding: 6px 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">
            </div>
          
            <div style="display: flex; gap: 10px; margin-top: 22px;">
              <button type="submit"
                      style="background-color: #0b2c4e; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                Filtrar
              </button>
          
              <a href="{% url 'libros:listar_ctacorriente' %}" style="text-decoration: none;">
                <button type="button"
                        style="background-color: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                  Limpiar
                </button>
              </a>
            </div>
          </form>
          

        {% endif %}
        {% if facturas %}
        <table border="1" style="width: 100%; border-collapse: collapse; text-align: left; font-size: 14px;">
            <thead>
                <tr style="background-color: #f2f2f2;">
                    <th style="padding: 8px;">Factura Nº</th>
                    <th style="padding: 8px;">DNI</th>
                    <th style="padding: 8px;">Cliente</th>
                    <th style="padding: 8px;">Total</th>
                    <th style="padding: 8px;">Fecha</th>
                    <th style="padding: 8px;">Pagos</th>
                    <th style="padding: 8px;">Debe</th>
                    {% if user.is_staff %}
                    <th style="padding: 8px;">Acciones</th>
                    {% endif %}
                </tr>
            </thead>

{% for factura in facturas %}
    {% with metodo1=factura.metodo_pago.tarjeta_nombre|default:"" %}
    {% with metodo2=factura.metodo_pago_manual|default:"" %}
        {% if metodo1|lower == "cuenta corriente" or metodo2|lower == "cuenta corriente" %}
            {% with cuenta_corriente=factura.cuentacorriente_set.last %}
                <tr>
                    <td>{{ factura.numero_factura }}</td>
                    <td>{{ factura.dni_cliente }}</td>
                    <td>{{ factura.nombre_cliente }} {{ factura.apellido_cliente }}</td>
                    <td>${{ factura.total_con_interes }}</td>
                    <td>{{ factura.fecha }}</td>
                    <td>${{ pagos_por_factura|get_item:factura.id|default:"0.00" }}</td>
                    <td>${{ deuda_por_factura|get_item:factura.id|floatformat:2|default:"0.00" }}</td>
                    <td>
                        {% if user.is_staff %}
                        <a href="{% url 'libros:pago_credito' factura.id %}">
                            <button style="background-color: #11530f; color: white;">Pago Crédito</button>
                        </a>
                        {% endif %}
                        <a href="{% url 'libros:generar_pdf_credito' factura.id %}">
                            <button style="background-color: #061322; color: white;">PDF</button>
                        </a>
                    </td>
                </tr>
            {% endwith %}
        {% endif %}
    {% endwith %}
    {% endwith %}
{% endfor %}

                



            </tbody>
            
            <tfoot>
                <tr>
                    <th colspan="3" style="padding: 8px; text-align: right;">Total:</th>
                    <th style="padding: 8px;">${{ total_general }}</th>  
                    <th colspan="4"></th>
                </tr>
                <tr>
                    <th colspan="3" style="padding: 8px; text-align: right;">Pagos:</th>
                    <th style="padding: 8px;">${{ total_pagos }}</th>  
                    <th colspan="4"></th>
                </tr>
                <tr>
                    <th colspan="3" style="padding: 8px; text-align: right; color: #dc3545;">Debe:</th>
                    <th style="padding: 8px;">${{ total_deuda }}</th>  
                    <th colspan="4"></th>
                </tr>
            </tfoot>
           
            
        </table>
        {% else %}
        <p class="no-facturas">No hay facturas registradas con "Cuenta Corriente".</p>
        {% endif %}
    </main>
    
{% endblock %}
